(function(){var a=this.Locater={version:"1.0"}}());(function(c){var b=c.Rules={_rules:{},getRule:function(d){return this._rules[d]},getRules:function(){return this._rules},isDefined:function(d){return(this._rules[d])?true:false},define:function(d,e){if(!(Type.isFunction(e.invoke)||Type.isFunction(e))){throw new Error("The rule is an object or it is not a function.")}switch(typeOf(e)){case"object":this._rules[d]=e.invoke;break;case"function":this._rules[d]=e;break}}};var a={currentWatched:function(e,d){return(e==null)},positionChanged:function(e,d){if(e==null){return false}return !(e.getLatitude()==d.getLatitude()&&e.getLongitude()==d.getLongitude())},latitudeChanged:function(e,d){if(e==null){return false}return e.getLatitude()!=d.getLatitude()},longitudeChanged:function(e,d){if(e==null){return false}return e.getLongitude()!=d.getLongitude()},altitudeChanged:function(e,d){if(e==null){return false}return e.getAltitude()!=d.getAltitude()},accuracyChanged:function(e,d){if(e==null){return false}return e.getAccuracy()!=d.getAccuracy()},altitudeAccuracyChanged:function(e,d){if(e==null){return false}return e.getAltitudeAccuracy()!=d.getAltitudeAccuracy()},headingChanged:function(e,d){if(e==null){return false}return e.getHeading()!=d.getHeading()},speedChanged:function(e,d){if(e==null){return false}return e.getSpeed()!=d.getSpeed()}};for(key in a){b.define(key,a[key])}}(Locater));(function(h){function i(j){this._radius=j}function d(j){return(2*Math.PI)*j/360}function e(k,j){if(!this.getCurrent()){this.setCurrent(j)}if(!(this.distance(this.getCurrent(),j)>this.getRadius())){return false}else{this.setCurrent(j);return true}}function g(){return this._rate}function b(){return this._radius}function f(){return this._watch}function c(j){this._watch=j}function a(o,n){var l=this.radians(o.getLatitude());var j=this.radians(o.getLongitude());var m=this.radians(n.getLatitude());var k=this.radians(n.getLongitude());var p=this.getRate()*Math.acos(Math.cos(l)*Math.cos(m)*Math.cos(k-j)+Math.sin(l)*Math.sin(m));return Math.round(p*100)/100}i.implement({_watch:null,_rate:0,radians:d.protect(),invoke:e,distance:a,getRate:g.protect(),getRadius:b.protect(),getCurrent:f.protect(),setCurrent:c.protect()});h.RadiusRule=i}(Locater.Rules));(function(b){function a(c){b.RadiusRule.apply(this,[c])}a.implement(new b.RadiusRule());a.implement({_rate:3959});b.MileRule=a}(Locater.Rules));(function(b){function a(c){b.RadiusRule.apply(this,[c])}a.implement(new b.RadiusRule());a.implement({_rate:6371});b.KilometerRule=a}(Locater.Rules));(function(c){var b=c.Handler={create:function(e,d){if(!this[e]){throw new Error("It tries to make an invalid handler.")}return new this[e](d)},isHandler:function(f){var e="Application";var d=(Type.isFunction(f["set"+e])&&Type.isFunction(f["get"+e]));return d}};function a(f){var d=["start","stop","isWatching"];var e={};d.each(function(g){e[g]=Function.from(f[g]).bind(f)});return e}b.Handler=new Class({setApplication:function(d){this._app=a(d)},getApplication:function(){return this._app}});b.SimpleHandler=function(d){return Object.merge(this,d)};b.SimpleHandler.implement(new b.Handler())}(Locater));(function(b,a){b.Dispatcher=new Class({_handlers:[],addHandler:function(c){if(!a.isHandler(c)){throw new Error("It is not a handler.")}this._handlers.push(c);return this},addHandlers:function(d){var c=this;d.each(function(e){c.addHandler(e)});return this},removeHandler:function(c){if(!this.hasHandler(c)){return this}this._handlers.erase(c);return this},removeHandlers:function(d){var c=this;d.each(function(e){c.removeHandler(e)});return this},hasHandler:function(c){return this._handlers.contains(c)},dispatch:function(c,d){this._handlers.each(function(e){if(Type.isFunction(e[c])){e[c].apply(e,[d])}})}})}(Locater,Locater.Handler));(function(b){var a=b.Geolocation=new Class({options:{enableHighAccuracy:true,timeout:10000,maximumAge:0},_getWatchID:function(){return this._watchID}.protect(),_setWatchID:function(d){this._watchID=d}.protect(),_getGeolocation:function(){return navigator.geolocation}.protect(),isWatching:function(){return(this._getWatchID()!=null)}});var c=b.Adapter={create:function(e,d){if(!this[e]){throw new Error("It tries to make an invalid adaptor.")}return new this[e](d)}}}(Locater));(function(c){var a={latitude:0,longitude:0,altitude:0,accuracy:0,altitudeAccuracy:0,heading:0,speed:0};function b(f){var g=f.charAt(0).toUpperCase();var e=f.substr(1,f.length);var d="get"+g+e;return d}c.Context=function(g){var i={};var h=Object.keys(a);var f=Object.subset(g,h);Object.each(a,function(k,j){i[j]=f[j]||k});for(var e in i){var d=b(e);this[d]=Function.from(i[e])}return this};c.Context.implement({toString:function(){var g=[];for(var e in a){var d=b(e);var f=this[d]();if(Type.isObject(f)){if(Type.isFunction(f.toString)){f=f.toString()}else{continue}}g.push(e+"="+f)}return g.join(" ")}})}(Locater.Handler));(function(b,c,a){b.Application=new Class({Implements:[Options],options:{},_adapter:null,_dispacher:null,initialize:function(d,e){if(!(Type.isFunction(d.start)&&Type.isFunction(d.stop))){throw new Error("It is not an adaptor.")}this.setOptions(e);this._adapter=d;this._adapter.setOptions({watchHandler:this.onWatchSuccess.bind(this),errorHandler:this.onError.bind(this)});this._dispacher=new b.Dispatcher()},addHandler:function(d){if(!a.isHandler(d)){throw new Error("It is not a handler.")}d.setApplication(this);this._dispacher.addHandler(d);return this},addHandlers:function(e){var d=this;e.each(function(g,f){d.addHandler(g)});return this},removeHandler:function(d){this._dispacher.removeHandler(d);return this},removeHandlers:function(d){this._dispacher.removeHandlers(d);return this},onWatchSuccess:function(d){var f=new b.Handler.Context(d.coords);var e=this;var g=b.Rules.getRules();Object.each(g,function(i,h){if(i.apply(i,[e.context,f])){e._dispacher.dispatch(h,f)}});this.context=f},onError:function(d){this._dispacher.dispatch("error",d)},run:function(){if(this.isWatching()){return}try{this._adapter.start()}catch(d){this._dispacher.dispatch("error",d)}this._dispacher.dispatch("start")},isWatching:function(){return this._adapter.isWatching()},start:function(){this.run()},stop:function(){if(!this.isWatching()){return}this._adapter.stop();this._dispacher.dispatch("stop")}})}(Locater,Locater.Adapter,Locater.Handler));(function(a,b){b.CurrentPositionAdapter=new Class({Implements:[a.Geolocation,Options],options:{watchHandler:null,errorHandler:null},initialize:function(c){this.setOptions(c)},start:function(){var d=this._getGeolocation();if(!d){throw new Error("Geolocation API is not supported.")}var e=this.options;var c=Object.subset(e,["enableHighAccuracy","timeout","maximumAge"]);if(e.watchHandler==null){throw new Error("Please specify either watchHandler.")}d.getCurrentPosition(e.watchHandler,e.errorHandler,c);this._setWatchID(new Date().toString())},stop:function(){this._setWatchID(null)}})}(Locater,Locater.Adapter));(function(a,b){b.WatchPositionAdapter=new Class({Implements:[a.Geolocation,Options],options:{watchHandler:null,errorHandler:null},initialize:function(c){this.setOptions(c)},start:function(){var d=this._getGeolocation();if(!d){throw new Error("Geolocation API is not supported.")}var e=this.options;var c=Object.subset(e,["enableHighAccuracy","timeout","maximumAge"]);if(e.watchHandler==null){throw new Error("Please specify either watchHandler.")}this._setWatchID(d.watchPosition(e.watchHandler,e.errorHandler,c))},stop:function(){var c=this._getGeolocation();c.clearWatch(this._getWatchID());this._setWatchID(null)}})}(Locater,Locater.Adapter));(function(b){var a=b.Emulator=new Class({options:{},_getWatchID:function(){return this._watchID}.protect(),_setWatchID:function(c){this._watchID=c}.protect(),isWatching:function(){return(this._getWatchID()!=null)}})}(Locater));(function(a){a.CurrentPositionEmulator=new Class({Implements:[a,Options],options:{watchHandler:null,errorHandler:null,position:null},_position:null,initialize:function(c){this.setOptions(c);var b=Object.subset(this.options,["position"]);Object.each(b,function(e,d){if(e==null||e==undefined){return}this["set"+d.capitalize()](e);delete this.options[d]},this)},setPosition:function(b){if(!(Type.isObject(b)||b instanceof Error)){throw new TypeError("Please specify an Error object as position from an object.")}this._position=b;return this},getPosition:function(){return this._position},start:function(){var c=this.options;var b=this.getPosition();if(!b){throw new TypeError("Please specify coordinates information for the verification or the error object.")}else{if(b instanceof Error){c.errorHandler(b)}else{if(Type.isObject(b)){c.watchHandler(b)}}}this._setWatchID(new Date().toString())},stop:function(){this._setWatchID(null)}})}(Locater.Emulator));(function(a){a.WatchPositionEmulator=new Class({Implements:[a,Options],options:{watchHandler:null,errorHandler:null,positions:null,interval:1000},_current:0,_positions:[],_interval:1000,initialize:function(c){this.setOptions(c);var b=Object.subset(this.options,["positions","interval"]);Object.each(b,function(e,d){if(e==null||e==undefined){return}this["set"+d.capitalize()](e);delete this.options[d]},this)},setPositions:function(b){if(!Type.isArray(b)){throw new TypeError("Please specify the coordinates position in array.")}this._positions=b;return this},getPositions:function(){return this._positions},setInterval:function(b){if(!Type.isNumber(b)){throw new TypeError("Please specify interval numerically.")}this._interval=b;return this},getInterval:function(){return this._interval},_nextPosition:function(){var b=this._current+1;if(b>=this._positions.length){clearTimeout(this._getWatchID());return false}this._current=b;return true},_getWatchPosition:function(){return this._positions[this._current]},_watchPosition:function(){var d=this.options;var b=this._getWatchPosition();var c=this.getInterval();if(b===false){return}else{if(b instanceof Error){d.errorHandler(b)}else{if(Type.isObject(b)){d.watchHandler(b)}else{throw new TypeError("Please specify coordinates information for the verification or the error object.")}}}if(this._nextPosition()){this._watchPosition.delay(c,this)}},start:function(){this._watchPosition();this._setWatchID(new Date().toString())},stop:function(){clearTimeout(this._getWatchID());this._setWatchID(null)}})}(Locater.Emulator));(function(a){a.DebugHandler=new Class({Implements:[Options,a.Handler],options:{events:["currentWatched"]},initialize:function(b){this.setOptions(b);this._setup()},write:function(b){if(!window.console){return}if(!b){return}window.console.log(b.toString())},_setup:function(){var b=this;var c=this.options.events;c.each(function(d,e){b[d]=b.write})}.protect()})}(Locater.Handler));(function(a){a.CurrentPositionHandler=new Class({Implements:[Options,a.Handler],options:{currentMapSync:true},initialize:function(b,c){this.setOptions(c);if(!Type.isFunction(b.setPosition)){throw new Error("The setPosition method is not mounted.")}this._marker=b},currentWatched:function(b){this._update(b)},positionChanged:function(b){this._update(b)},_update:function(c){var e=c.getLatitude();var b=c.getLongitude();var f=new google.maps.LatLng(e,b);this._marker.setPosition(f);if(this._marker.getMap()&&this.options.currentMapSync){var d=this._marker.getMap();d.setCenter(f)}}.protect()})}(Locater.Handler));
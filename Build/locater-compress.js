(function(){var a=this.Locater={version:"1.0"}}());(function(c){var b=c.Rules={_rules:{},getRule:function(d){return this._rules[d]},getRules:function(){return this._rules},isDefined:function(d){return(this._rules[d])?true:false},define:function(d,e){if(!(Type.isFunction(e.invoke)||Type.isFunction(e))){throw new Error("The rule is an object or it is not a function.")}switch(typeOf(e)){case"object":this._rules[d]=e.invoke;break;case"function":this._rules[d]=e;break}}};var a={currentWatched:function(e,d){return(e==null)},positionChanged:function(e,d){if(e==null){return false}return !(e.getLatitude()==d.getLatitude()&&e.getLongitude()==d.getLongitude())},latitudeChanged:function(e,d){if(e==null){return false}return e.getLatitude()!=d.getLatitude()},longitudeChanged:function(e,d){if(e==null){return false}return e.getLongitude()!=d.getLongitude()},altitudeChanged:function(e,d){if(e==null){return false}return e.getAltitude()!=d.getAltitude()},accuracyChanged:function(e,d){if(e==null){return false}return e.getAccuracy()!=d.getAccuracy()},altitudeAccuracyChanged:function(e,d){if(e==null){return false}return e.getAltitudeAccuracy()!=d.getAltitudeAccuracy()},headingChanged:function(e,d){if(e==null){return false}return e.getHeading()!=d.getHeading()},speedChanged:function(e,d){if(e==null){return false}return e.getSpeed()!=d.getSpeed()}};for(key in a){b.define(key,a[key])}}(Locater));(function(c){var b=c.Handler={create:function(e,d){if(!this[e]){throw new Error("It tries to make an invalid handler.")}return new this[e](d)},isHandler:function(f){var e="Application";var d=(Type.isFunction(f["set"+e])&&Type.isFunction(f["get"+e]));return d}};function a(f){var d=["start","stop","isWatching"];var e={};d.each(function(g){e[g]=Function.from(f[g]).bind(f)});return e}b.Handler=new Class({setApplication:function(d){this._app=a(d)},getApplication:function(){return this._app}});b.SimpleHandler=function(d){return Object.merge(this,d)};b.SimpleHandler.implement(new b.Handler())}(Locater));(function(b,a){b.Dispacher=new Class({_handlers:[],addHandler:function(c){if(!a.isHandler(c)){throw new Error("It is not a handler.")}this._handlers.push(c);return this},addHandlers:function(d){var c=this;d.each(function(e){c.addHandler(e)});return this},removeHandler:function(c){if(!this.hasHandler(c)){return this}this._handlers.erase(c);return this},removeHandlers:function(d){var c=this;d.each(function(e){c.removeHandler(e)});return this},hasHandler:function(c){return this._handlers.contains(c)},dispatch:function(c,d){this._handlers.each(function(e){if(Type.isFunction(e[c])){e[c].apply(e,[d])}})}})}(Locater,Locater.Handler));(function(b){var a=b.Geolocation=new Class({options:{enableHighAccuracy:true,timeout:10000,maximumAge:0},_getWatchID:function(){return this._watchID}.protect(),_setWatchID:function(d){this._watchID=d}.protect(),_getGeolocation:function(){return navigator.geolocation}.protect(),isWatching:function(){return(this._getWatchID()!=null)}});var c=b.Adapter={create:function(e,d){if(!this[e]){throw new Error("It tries to make an invalid adaptor.")}return new this[e](d)},isAdapter:function(d){return(Type.isFunction(d.start)&&Type.isFunction(d.stop))}};c.CurrentPositionAdapter=new Class({Implements:[a,Options],options:{watchHandler:null,errorHandler:null},initialize:function(d){this.setOptions(d)},start:function(){var e=this._getGeolocation();if(!e){throw new Error("Geolocation API is not supported.")}var f=this.options;var d=Object.subset(f,["enableHighAccuracy","timeout","maximumAge"]);if(f.watchHandler==null){throw new Error("Please specify either watchHandler.")}e.getCurrentPosition(f._watchHandler,this._errorHandler,d);this._setWatchID(true)},_watchHandler:function(d){if(!this.isWatching()){return}var e=this.options;e.watchHandler(d);this.stop()},_errorHandler:function(d){if(!this.isWatching()){return}var e=this.options;e.errorHandler(d);this.stop()},stop:function(){this._setWatchID(null)}});c.WatchPositionAdapter=new Class({Implements:[a,Options],options:{watchHandler:null,errorHandler:null},initialize:function(d){this.setOptions(d)},start:function(){var e=this._getGeolocation();if(!e){throw new Error("Geolocation API is not supported.")}var f=this.options;var d=Object.subset(f,["enableHighAccuracy","timeout","maximumAge"]);if(f.watchHandler==null){throw new Error("Please specify either watchHandler.")}else{if(f.watchHandler){this._setWatchID(e.watchPosition(f.watchHandler,f.errorHandler))}}},stop:function(){var d=this._getGeolocation();d.clearWatch(this._getWatchID());this._setWatchID(null)}})}(Locater));(function(c){var a={latitude:0,longitude:0,altitude:0,accuracy:0,altitudeAccuracy:0,heading:0,speed:0};function b(f){var g=f.charAt(0).toUpperCase();var e=f.substr(1,f.length);var d="get"+g+e;return d}c.Context=function(g){var i={};var h=Object.keys(a);var f=Object.subset(g,h);Object.each(f,function(k,j){i[j]=k||a[j]});for(var e in i){var d=b(e);this[d]=Function.from(i[e])}return this};c.Context.implement({toString:function(){var g=[];for(var e in a){var d=b(e);var f=this[d]();if(Type.isObject(f)){if(Type.isFunction(f.toString)){f=f.toString()}else{continue}}g.push(e+"="+f)}return g.join(" ")}})}(Locater.Handler));(function(b,c,a){b.Application=new Class({Implements:[Options],options:{},_adapter:null,_dispacher:null,initialize:function(d,e){if(!c.isAdapter(d)){throw new Error("It is not an adaptor.")}this.setOptions(e);this._adapter=d;this._adapter.setOptions({watchHandler:this.onWatchSuccess.bind(this),errorHandler:this.onError.bind(this)});this._dispacher=new b.Dispacher()},addHandler:function(d){if(!a.isHandler(d)){throw new Error("It is not a handler.")}d.setApplication(this);this._dispacher.addHandler(d);return this},addHandlers:function(e){var d=this;e.each(function(g,f){d.addHandler(g)});return this},removeHandler:function(d){this._dispacher.removeHandler(d);return this},removeHandlers:function(d){this._dispacher.removeHandlers(d);return this},onWatchSuccess:function(d){var f=new b.Handler.Context(d.coords);var e=this;var g=b.Rules.getRules();Object.each(g,function(i,h){if(i.apply(i,[e.context,f])){e._dispacher.dispatch(h,f)}});this.context=f},onError:function(d){this._dispacher.dispatch("error",d)},run:function(){if(this.isWatching()){return}this._dispacher.dispatch("start");this.start()},isWatching:function(){return this._adapter.isWatching()},start:function(){if(this.isWatching()){return}this._adapter.start()},stop:function(){if(!this.isWatching()){return}this._adapter.stop();this._dispacher.dispatch("stop")}})}(Locater,Locater.Adapter,Locater.Handler));